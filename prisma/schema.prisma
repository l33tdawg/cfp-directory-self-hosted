// =============================================================================
// CFP Directory Self-Hosted - Prisma Schema
// =============================================================================
// Single-organization self-hosted CFP platform.
// The instance itself represents one organization.
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// SITE SETTINGS (Single Organization)
// =============================================================================

model SiteSettings {
  id          String   @id @default("default") // Singleton - always "default"
  name        String   @default("CFP System")
  description String?  @db.Text
  websiteUrl  String?
  logoUrl     String?
  
  // Landing page customization
  landingPageContent String? @db.Text // Rich text HTML content for landing page hero
  landingPageSections Json?           // Future: structured page sections
  
  // Legal pages content (editable from settings)
  privacyPolicyContent   String? @db.Text // Custom privacy policy content (HTML)
  termsOfServiceContent  String? @db.Text // Custom terms of service content (HTML)
  
  // Contact info
  contactEmail String?
  supportUrl   String?
  
  // Registration settings
  allowPublicSignup Boolean @default(false) // Allow speakers to self-register (others must be invited)
  
  // SMTP Configuration (database-only, no env vars)
  smtpHost          String?
  smtpPort          Int?      @default(587)
  smtpUser          String?
  smtpPass          String?   // Stored encrypted
  smtpSecure        Boolean   @default(false)  // true for port 465, false for other ports
  smtpFromName      String?   // Display name for emails
  smtpFromEmail     String?   // Sender email address
  smtpConfigured    Boolean   @default(false)  // Track if SMTP is properly set up
  
  // Federation settings
  federationEnabled Boolean @default(false)
  federationLicenseKey String?
  federationActivatedAt DateTime?
  federationLastHeartbeat DateTime?
  federationPublicKey String? @db.Text       // cfp.directory's public key (received)
  federationWarnings Json?
  federationFeatures Json?
  
  // Instance encryption keypair (for receiving encrypted data)
  instancePublicKey String? @db.Text         // This instance's public key (shared with cfp.directory)
  instancePrivateKeyEncrypted String? @db.Text // Private key (encrypted with AES-256-GCM)
  instanceKeyGeneratedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_settings")
}

// =============================================================================
// EMAIL TEMPLATES
// =============================================================================
// Database-driven email templates with variable substitution support
// Admin can customize subject and content for all system emails

model EmailTemplate {
  id          String   @id @default(cuid())
  type        String   @unique  // e.g., "submission_accepted", "welcome"
  name        String             // Display name for UI (e.g., "Submission Accepted")
  subject     String             // Email subject line (supports {variables})
  content     String   @db.Text  // Rich HTML content with {variable} placeholders
  variables   Json     @default("{}") // Available variables: {"varName": "description"}
  description String?            // Admin description of when template is used
  category    String   @default("general") // authentication, submissions, communication, announcements
  enabled     Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([category])
  @@map("email_templates")
}

// =============================================================================
// AUTHENTICATION (NextAuth.js Compatible)
// =============================================================================

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  emailVerified  DateTime?
  passwordHash   String?   // For credentials provider
  name           String?
  image          String?   // Avatar URL
  role           UserRole  @default(USER)
  sessionVersion Int       @default(0) // Incremented on role change to invalidate JWT sessions
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // Speaker profile (one-to-one)
  speakerProfile    SpeakerProfile?

  // Reviewer profile (one-to-one)
  reviewerProfile   ReviewerProfile?

  // Talks library (reusable talk proposals)
  talks             Talk[]

  // Application relations
  submissions       Submission[]
  reviews           Review[]
  sentMessages      Message[]          @relation("SentMessages")
  reviewDiscussions ReviewDiscussion[]
  reviewTeamEvents  ReviewTeamMember[]
  
  // Invitations sent by this user
  sentInvitations   UserInvitation[]
  
  // Activity log entries by this user
  activityLogs      ActivityLog[]

  @@map("users")
}

enum UserRole {
  USER      // Can submit talks
  SPEAKER   // Alias for USER, used for speakers who completed onboarding
  REVIEWER  // Can review submissions (when assigned to events)
  ORGANIZER // Can manage events
  ADMIN     // Full access including settings
}

// =============================================================================
// USER INVITATIONS
// =============================================================================

model UserInvitation {
  id          String    @id @default(cuid())
  email       String
  role        UserRole  @default(USER)
  token       String    @unique
  invitedBy   String
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  
  inviter     User      @relation(fields: [invitedBy], references: [id], onDelete: Cascade)
  
  @@index([email])
  @@index([token])
  @@map("user_invitations")
}

// =============================================================================
// ACTIVITY LOGGING
// =============================================================================

model ActivityLog {
  id          String    @id @default(cuid())
  userId      String?   // Null for system actions
  action      String    // e.g., "USER_ROLE_CHANGED", "SUBMISSION_ACCEPTED"
  entityType  String    // e.g., "User", "Submission", "Event"
  entityId    String
  metadata    Json?     // Additional context
  ipAddress   String?
  createdAt   DateTime  @default(now())
  
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}

// =============================================================================
// SPEAKER PROFILES (Federation Compatible)
// =============================================================================
// Must match cfp.directory fields for federation compatibility

model SpeakerProfile {
  id                      String            @id @default(cuid())
  userId                  String            @unique

  // Basic Info (Onboarding Step 1)
  fullName                String?           // Display name (required in onboarding)
  bio                     String?           @db.Text // Rich text, min 50 chars
  location                String?           // "City, Country", max 100 chars
  company                 String?
  position                String?           // Job title
  websiteUrl              String?
  photoUrl                String?           // Profile photo URL

  // Social Links (at least one required in onboarding)
  linkedinUrl             String?
  twitterHandle           String?           // Without @
  githubUsername          String?

  // Speaking Experience (Onboarding Step 2)
  expertiseTags           String[]          @default([]) // Up to 25 tags
  speakingExperience      String?           @db.Text // Rich text
  experienceLevel         ExperienceLevel?
  languages               String[]          @default(["English"]) // Up to 5

  // Preferences (Onboarding Step 3 - all optional)
  presentationTypes       String[]          @default([]) // Talk, Workshop, etc.
  audienceTypes           String[]          @default([]) // Beginners, Advanced, etc.
  willingToTravel         Boolean           @default(false)
  travelRequirements      String?           @db.Text
  virtualEventExperience  Boolean           @default(false)
  techRequirements        String?           @db.Text

  // Onboarding Status
  onboardingCompleted     Boolean           @default(false)
  onboardingStep          Int               @default(1) // Track progress (1-4)

  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt

  user                    User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("speaker_profiles")
}

enum ExperienceLevel {
  NEW           // First-time speaker
  EXPERIENCED   // Several talks at meetups/small conferences
  PROFESSIONAL  // Regular speaker at conferences
  KEYNOTE       // Keynote speaker level
}

// =============================================================================
// REVIEWER PROFILES
// =============================================================================
// Profile information for reviewers, shown on "Meet our Team" page

model ReviewerProfile {
  id                      String   @id @default(cuid())
  userId                  String   @unique

  // Basic Info
  fullName                String
  designation             String?             // Job title/role
  company                 String?
  bio                     String?  @db.Text
  photoUrl                String?

  // Social Links
  linkedinUrl             String?
  twitterHandle           String?
  githubUsername          String?
  websiteUrl              String?

  // Expertise & Experience
  expertiseAreas          String[] @default([])  // Topics they're expert in
  yearsOfExperience       Int?
  hasReviewedBefore       Boolean  @default(false)
  conferencesReviewed     String?  @db.Text      // Previous conferences reviewed

  // Review Preferences
  reviewCriteria          String[] @default([])  // What they focus on when reviewing
  hoursPerWeek            String?               // "2-5", "5-10", "10+"
  preferredEventSize      String?               // "small", "medium", "large", "any"
  additionalNotes         String?  @db.Text

  // Display Settings
  showOnTeamPage          Boolean  @default(true)  // Show in "Meet our Team"
  displayOrder            Int      @default(0)     // Order on team page

  // Onboarding Status
  onboardingCompleted     Boolean  @default(false)
  onboardingStep          Int      @default(1)

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reviewer_profiles")
}

// =============================================================================
// TALKS LIBRARY
// =============================================================================
// Reusable talk proposals that speakers can submit to multiple events

model Talk {
  id              String    @id @default(cuid())
  userId          String

  // Talk Content
  title           String
  abstract        String    @db.Text
  description     String?   @db.Text    // Extended description
  outline         String?   @db.Text    // Talk structure/outline
  
  // Talk Metadata
  type            TalkType  @default(SESSION)
  durationMin     Int       @default(30)
  targetAudience  String[]  @default([])
  prerequisites   String?   @db.Text
  speakerNotes    String?   @db.Text    // Private notes for the speaker
  
  // Categorization
  tags            String[]  @default([])
  
  // Status
  isArchived      Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  submissions     Submission[]

  @@map("talks")
}

enum TalkType {
  KEYNOTE
  SESSION
  WORKSHOP
  LIGHTNING
  PANEL
  BOF           // Birds of a Feather
  TUTORIAL
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// =============================================================================
// TOPICS (Admin Manageable)
// =============================================================================
// Database-driven topic system used across speakers, talks, reviewers, and events

model Topic {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String?  // e.g., "Core Security", "Offensive Security", etc.
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  usageCount  Int      @default(0) // Track popularity for sorting
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([isActive, sortOrder])
  @@index([name])
  @@map("topics")
}

// =============================================================================
// EVENTS
// =============================================================================

model Event {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?     @db.Text
  websiteUrl  String?
  
  // Location Details
  location    String?     // Legacy field - kept for compatibility
  venueName   String?
  venueAddress String?
  venueCity   String?
  country     String?     @default("US")
  isVirtual   Boolean     @default(false)
  virtualUrl  String?
  
  // Event Configuration
  eventType   String      @default("conference") // conference, meetup, workshop, etc.
  startDate   DateTime?
  endDate     DateTime?
  startTime   String?     @default("09:00")
  endTime     String?     @default("17:00")
  timezone    String      @default("UTC")
  
  // Topics & Audience
  topics        String[]  @default([])
  audienceLevel String[]  @default([])
  
  // CFP Settings
  cfpOpensAt      DateTime?
  cfpClosesAt     DateTime?
  cfpStartTime    String?   @default("09:00")
  cfpEndTime      String?   @default("17:00")
  cfpDescription  String?   @db.Text  // Legacy - kept for compatibility
  cfpGuidelines   String?   @db.Text  // Rich text CFP guidelines
  speakerBenefits String?   @db.Text  // Rich text speaker benefits
  
  // Review Settings
  reviewType            String   @default("scoring") // scoring, voting, ranking
  minReviewsPerTalk     Int      @default(2)
  enableSpeakerFeedback Boolean  @default(false)
  allowReviewerMessages Boolean  @default(false) // Allow reviewers to message speakers directly
  
  // Notification Settings
  notifyOnNewSubmission Boolean @default(true)
  notifyOnNewReview     Boolean @default(false)
  
  // Status
  status      EventStatus @default(DRAFT)
  isPublished Boolean     @default(false) // Legacy - kept for compatibility

  // Federation (Phase 4)
  isFederated      Boolean @default(false)
  federatedEventId String? @unique
  webhookSecret    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tracks         EventTrack[]
  formats        EventFormat[]       // Legacy - kept for compatibility
  talkFormats    EventTalkFormat[]   // New comprehensive talk formats
  reviewCriteria EventReviewCriteria[]
  submissions    Submission[]
  reviewTeam     ReviewTeamMember[]

  @@map("events")
}

enum EventStatus {
  DRAFT
  PUBLISHED
}

// =============================================================================
// EVENT TALK FORMATS
// =============================================================================
// Configurable talk formats for each event (e.g., "Keynote - 45 min", "Workshop - 2 hours")

model EventTalkFormat {
  id          String  @id @default(cuid())
  eventId     String
  name        String
  description String?
  durationMin Int     @default(30)
  sortOrder   Int     @default(0)
  
  event       Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([eventId])
  @@map("event_talk_formats")
}

// =============================================================================
// EVENT REVIEW CRITERIA
// =============================================================================
// Configurable review criteria for each event with weights

model EventReviewCriteria {
  id          String  @id @default(cuid())
  eventId     String
  name        String
  description String?
  weight      Int     @default(3)  // 1-5 scale
  sortOrder   Int     @default(0)
  
  event       Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([eventId])
  @@map("event_review_criteria")
}

model EventTrack {
  id          String  @id @default(cuid())
  eventId     String
  name        String
  description String? @db.Text
  color       String? // Hex color for UI

  event       Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@unique([eventId, name])
  @@map("event_tracks")
}

model EventFormat {
  id          String @id @default(cuid())
  eventId     String
  name        String // "Talk", "Workshop", "Lightning Talk"
  durationMin Int    // Duration in minutes

  event       Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@unique([eventId, name])
  @@map("event_formats")
}

// =============================================================================
// SUBMISSIONS
// =============================================================================

model Submission {
  id        String  @id @default(cuid())
  eventId   String
  speakerId String
  trackId   String?
  formatId  String?
  talkId    String? // Link to reusable talk from library

  title          String
  abstract       String  @db.Text
  outline        String? @db.Text
  targetAudience String?
  prerequisites  String? @db.Text

  status          SubmissionStatus @default(PENDING)
  statusUpdatedAt DateTime?

  // Federation tracking
  isFederated          Boolean @default(false)
  federatedSpeakerId   String?
  externalSubmissionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event      Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  speaker    User                 @relation(fields: [speakerId], references: [id], onDelete: Cascade)
  track      EventTrack?          @relation(fields: [trackId], references: [id], onDelete: SetNull)
  format     EventFormat?         @relation(fields: [formatId], references: [id], onDelete: SetNull)
  talk       Talk?                @relation(fields: [talkId], references: [id], onDelete: SetNull)
  materials  SubmissionMaterial[]
  coSpeakers CoSpeaker[]
  reviews    Review[]
  messages   Message[]

  @@map("submissions")
}

enum SubmissionStatus {
  PENDING
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  WAITLISTED
  WITHDRAWN
}

model SubmissionMaterial {
  id           String  @id @default(cuid())
  submissionId String
  type         String  // "slides", "video", "document", "other"
  title        String
  description  String? @db.Text
  fileUrl      String? // Local file path or external URL
  externalUrl  String? // For linked content (e.g., YouTube)
  fileName     String?
  fileSize     Int?    // Size in bytes
  mimeType     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("submission_materials")
}

model CoSpeaker {
  id           String  @id @default(cuid())
  submissionId String
  name         String
  email        String?
  bio          String? @db.Text
  avatarUrl    String?
  isLinked     Boolean @default(false) // Linked to existing user
  linkedUserId String?

  createdAt DateTime @default(now())

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("co_speakers")
}

// =============================================================================
// REVIEWS
// =============================================================================

model ReviewTeamMember {
  id      String       @id @default(cuid())
  eventId String
  userId  String
  role    ReviewerRole @default(REVIEWER)
  addedAt DateTime     @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("review_team_members")
}

enum ReviewerRole {
  LEAD
  REVIEWER
}

model Review {
  id           String @id @default(cuid())
  submissionId String
  reviewerId   String

  // Scoring (1-5 scale)
  contentScore      Int?
  presentationScore Int?
  relevanceScore    Int?
  overallScore      Int?

  privateNotes   String?               @db.Text // Only visible to review team
  publicNotes    String?               @db.Text // Sent to speaker on decision
  recommendation ReviewRecommendation?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submission  Submission         @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  reviewer    User               @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  discussions ReviewDiscussion[]

  @@unique([submissionId, reviewerId])
  @@map("reviews")
}

enum ReviewRecommendation {
  STRONG_ACCEPT
  ACCEPT
  NEUTRAL
  REJECT
  STRONG_REJECT
}

model ReviewDiscussion {
  id       String @id @default(cuid())
  reviewId String
  authorId String
  content  String @db.Text

  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("review_discussions")
}

// =============================================================================
// MESSAGING
// =============================================================================

model Message {
  id           String     @id @default(cuid())
  submissionId String
  senderId     String?    // null if from federated speaker
  senderType   SenderType

  subject String?
  body    String  @db.Text
  isRead  Boolean @default(false)
  readAt  DateTime?

  // Threading
  parentId String?
  parent   Message?  @relation("MessageThread", fields: [parentId], references: [id], onDelete: SetNull)
  replies  Message[] @relation("MessageThread")

  // Federation tracking
  federatedMessageId String?

  createdAt DateTime @default(now())

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  sender     User?      @relation("SentMessages", fields: [senderId], references: [id], onDelete: SetNull)

  @@map("messages")
}

enum SenderType {
  ORGANIZER
  SPEAKER
  REVIEWER
}

// =============================================================================
// FEDERATED SPEAKERS (Phase 4)
// =============================================================================
// Extended to match cfp.directory speaker profile fields

model FederatedSpeaker {
  id                      String   @id @default(cuid())
  cfpDirectorySpeakerId   String   @unique
  localUserId             String?  // Link to local User if they register

  // Basic Info (matches SpeakerProfile)
  name                    String
  email                   String?
  bio                     String?  @db.Text
  avatarUrl               String?
  location                String?
  company                 String?
  position                String?
  websiteUrl              String?

  // Social Links
  linkedinUrl             String?
  twitterHandle           String?
  githubUsername          String?

  // Speaking Profile
  expertiseTags           String[] @default([])
  speakingExperience      String?  @db.Text
  experienceLevel         String?  // String to avoid enum sync issues
  languages               String[] @default([])

  // Preferences
  presentationTypes       String[] @default([])
  audienceTypes           String[] @default([])
  willingToTravel         Boolean  @default(false)
  virtualEventExperience  Boolean  @default(false)

  // Federation Consent & Metadata
  consentGrantedAt        DateTime
  consentScopes           Json     // ["profile", "social_links", "materials", "email"]
  lastSyncedAt            DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("federated_speakers")
}

// =============================================================================
// WEBHOOK QUEUE (Dead Letter Queue)
// =============================================================================

model WebhookQueue {
  id            String   @id @default(cuid())
  eventId       String
  webhookType   String   // submission.created, status_updated, etc.
  payload       String   @db.Text // JSON stringified payload
  webhookUrl    String
  attempt       Int      @default(1)
  lastError     String?  @db.Text
  lastAttemptAt DateTime @default(now())
  nextRetryAt   DateTime?
  status        String   @default("pending_retry") // pending_retry, dead_letter, success

  createdAt DateTime @default(now())

  @@index([status, nextRetryAt])
  @@map("webhook_queue")
}

// =============================================================================
// PLUGIN SYSTEM (v1.1.0)
// =============================================================================
// Extensible plugin system for custom functionality

model Plugin {
  id          String   @id @default(cuid())
  name        String   @unique          // e.g., "slack-notifications"
  displayName String                    // e.g., "Slack Notifications"
  description String?  @db.Text
  version     String                    // Plugin version (semver)
  apiVersion  String                    // Target API version (e.g., "1.0")
  author      String?
  homepage    String?                   // Plugin documentation URL
  
  // Installation
  source      String                    // "local" | "npm" | "git"
  sourcePath  String                    // Path/package name/repo URL
  
  // Status
  enabled     Boolean  @default(false)
  installed   Boolean  @default(true)
  
  // Configuration
  config      Json     @default("{}")   // Plugin-specific settings
  configSchema Json?                    // JSON Schema for config validation
  
  // Permissions
  permissions Json     @default("[]")   // Required permissions
  
  // Metadata
  hooks       String[] @default([])     // Registered hook names
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  logs        PluginLog[]
  jobs        PluginJob[]
  data        PluginData[]

  @@map("plugins")
}

model PluginLog {
  id        String   @id @default(cuid())
  pluginId  String
  level     String   // "debug" | "info" | "warn" | "error"
  message   String   @db.Text
  metadata  Json?
  createdAt DateTime @default(now())
  
  plugin    Plugin   @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@index([pluginId, createdAt])
  @@index([level])
  @@map("plugin_logs")
}

// =============================================================================
// PLUGIN JOB QUEUE (v1.2.0)
// =============================================================================
// Background job queue for async plugin operations with concurrency safety

model PluginJob {
  id          String    @id @default(cuid())
  pluginId    String
  type        String                          // Job type defined by plugin
  payload     Json                            // Job data
  status      String    @default("pending")   // pending, running, completed, failed
  result      Json?                           // Job result or error
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  runAt       DateTime  @default(now())       // Scheduled time
  startedAt   DateTime?
  completedAt DateTime?
  
  // Locking fields (concurrency safety)
  lockedAt    DateTime?                       // When job was locked
  lockedBy    String?                         // Worker instance ID
  lockTimeout Int       @default(300)         // Lock timeout in seconds
  
  // Priority (lower = higher priority)
  priority    Int       @default(100)
  
  createdAt   DateTime  @default(now())
  
  plugin      Plugin    @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@index([status, runAt, lockedAt])
  @@index([pluginId])
  @@index([priority, runAt])
  @@map("plugin_jobs")
}

// =============================================================================
// PLUGIN DATA STORE (v1.7.0)
// =============================================================================
// Key-value data store for plugins with optional encryption

model PluginData {
  id        String   @id @default(cuid())
  pluginId  String
  namespace String
  key       String
  value     Json
  encrypted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plugin    Plugin   @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@unique([pluginId, namespace, key])
  @@index([pluginId, namespace])
  @@map("plugin_data")
}
